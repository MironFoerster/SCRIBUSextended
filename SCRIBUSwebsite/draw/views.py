from django.contrib.auth.decorators import login_required
from django.shortcuts import render
from django.http import JsonResponse
from .models import Shape, Scribing
from gallery.models import Design
import json
import threading
from django.core.cache import cache
#from . import control
#import tensorflow as tf
#from . import scribemodel as scribe
import os

def index(request):
    context = {'shapes': Shape.objects.all(),
               'designs': Design.objects.all(),
               'designnames': list(Design.objects.values_list("name", flat=True))}
    return render(request, 'draw/index.html', context)


"""base_path = "C:/Users/miron/Git/scribeAI"

run_name = "miron"

model = scribe.Model()
model.compile(optimizer='adam',
              loss=[scribe.Loss(), None, None],
              metrics=[['accuracy'], [None, None]],
              run_eagerly=True)
model.evaluate(test_set.batch(batch_size=1).take(1), verbose=2)
model.load_weights(os.path.join(base_path, "checkpoints", run_name, "weights.hdf5"))
model.evaluate(test_set.batch(batch_size=1).take(1), verbose=2)


def generate(request):
    print('scribe view')
    words = json.loads(request.body)['words']
    preds = []
    for word in words:
        pred = model.predict(word)
        preds.append(pred)

    scribing = Scribing(hws=pred, words=words)
    scribing.save()
    return JsonResponse(scribing.hws)  # hws = [{"path":[...]}, {"path":[...]}, ...]
"""

# the automatic pursuer kicked the razor
mock_words = [[[[90, 190], [93, 181], [97, 176], [94, 174], [95, 173], [95, 172], [94, 174], [100, 184], [103, 200], [104, 219], [107, 245], [110, 273], [112, 308], [121, 342], [124, 368], [131, 385], [131, 391], [135, 393], [132, 390], [131, 385], [120, 374]], [[95, 286], [95, 286], [94, 287], [94, 287], [94, 287], [99, 287], [104, 287], [119, 289], [130, 287], [140, 282], [152, 280], [161, 280], [166, 281]], [[173, 216], [169, 208], [168, 203], [165, 200], [162, 198], [165, 201], [160, 199], [162, 203], [167, 211], [173, 229], [172, 248], [177, 274], [184, 304], [187, 331], [193, 356], [192, 368], [198, 375], [196, 377], [197, 376], [197, 376], [199, 372], [199, 367], [203, 356], [206, 340], [219, 324], [230, 310], [244, 300], [254, 294], [257, 290], [259, 294], [266, 297], [276, 306], [281, 317], [290, 333], [297, 343], [308, 354], [319, 360], [335, 365], [351, 365], [370, 360], [384, 349], [401, 341], [413, 331], [423, 320], [423, 307], [423, 300], [420, 290], [414, 285], [407, 280], [399, 279], [391, 283], [373, 285], [365, 295], [357, 307], [354, 315], [351, 320], [358, 329], [363, 338], [375, 348], [389, 355], [406, 360], [427, 365], [448, 364], [469, 364], [491, 362], [545, 352], [553, 346]]],
              [[[219, 173], [204, 161], [191, 162], [177, 165], [162, 174], [142, 197], [121, 230], [106, 261], [100, 285], [108, 301], [123, 310], [143, 301], [166, 293], [186, 273], [207, 253], [222, 242], [227, 237], [224, 241], [218, 261], [210, 293], [204, 321]], [[280, 188], [279, 201], [276, 216], [273, 240], [269, 273], [269, 293], [278, 309], [290, 316], [302, 316], [314, 303], [329, 282], [346, 262], [362, 233], [374, 216], [378, 220], [379, 225], [381, 244], [382, 269], [388, 284], [397, 296], [408, 291]], [[482, 114], [483, 109], [487, 113], [491, 129], [495, 156], [495, 193], [492, 225], [489, 245]], [[450, 232], [454, 220], [461, 220], [475, 223], [497, 225], [524, 230], [550, 224], [580, 218]], [[634, 171], [626, 163], [618, 165], [601, 179], [578, 206], [558, 235], [548, 264], [551, 288], [569, 302], [594, 304], [622, 297], [644, 286], [658, 264], [666, 240], [671, 219], [673, 199]], [[723, 175], [723, 192], [727, 223], [731, 251], [736, 267], [738, 274], [741, 278], [740, 274], [742, 273], [745, 265], [751, 244], [765, 222], [778, 192], [791, 173], [801, 172], [810, 183], [816, 202], [819, 226], [820, 246], [825, 257], [828, 257], [833, 256], [841, 247], [850, 229], [861, 206], [875, 184], [888, 170], [895, 168], [906, 186], [911, 206], [914, 234], [917, 249], [927, 260]], [[1058, 151], [1054, 152], [1046, 153], [1033, 169], [1014, 185], [1002, 208], [994, 230], [997, 242], [1003, 249], [1017, 246], [1033, 234], [1053, 225], [1067, 214], [1072, 213], [1076, 225], [1074, 242], [1076, 261], [1079, 261], [1089, 259], [1100, 236], [1117, 207]], [[1152, 100], [1158, 107], [1161, 122], [1162, 155], [1161, 184], [1160, 205]], [[1145, 159], [1161, 159], [1181, 167], [1197, 179], [1211, 200], [1222, 222], [1227, 237], [1230, 249], [1233, 256]], [[1384, 167], [1373, 162], [1356, 163], [1337, 174], [1322, 190], [1314, 209], [1313, 226], [1320, 244], [1333, 262], [1351, 269], [1377, 278], [1407, 281], [1439, 276]]],
              [[[116.5, 583], [113.5, 581], [115.5, 579], [114.5, 574], [113.5, 568], [107.5, 557], [104.5, 547], [98.5, 535], [93.5, 521], [92.5, 510], [88.5, 496], [87.5, 484], [88.5, 470], [88.5, 455], [89.5, 441], [87.5, 423], [93.5, 409], [95.5, 394], [96.5, 379], [96.5, 364], [105.5, 351], [111.5, 337], [122.5, 322], [139.5, 310], [154.5, 302], [172.5, 298], [191.5, 299], [203.5, 301], [217.5, 310], [221.5, 317], [229.5, 327], [236.5, 339], [233.5, 343], [233.5, 350], [228.5, 356], [221.5, 367], [203.5, 379], [183.5, 388], [166.5, 398], [152.5, 403], [137.5, 402], [133.5, 402], [129.5, 400], [130.5, 398], [128.5, 395]], [[282.5, 298], [281.5, 299], [281.5, 299], [281.5, 300], [281.5, 300], [281.5, 300], [277.5, 300], [277.5, 300], [276.5, 301], [279.5, 303], [278.5, 304], [277.5, 307], [273.5, 312], [281.5, 322], [277.5, 327], [280.5, 337], [284.5, 347], [289.5, 354], [291.5, 358], [293.5, 361], [300.5, 366], [308.5, 369], [312.5, 369], [317.5, 370], [318.5, 369], [320.5, 371], [318.5, 368], [318.5, 367], [315.5, 364], [326.5, 363], [332.5, 355], [340.5, 349], [344.5, 343], [346.5, 341], [347.5, 339], [349.5, 337], [348.5, 330], [351.5, 325], [354.5, 321], [352.5, 316], [348.5, 309], [349.5, 306], [347.5, 301], [349.5, 299], [342.5, 295], [342.5, 295], [342.5, 295], [341.5, 296], [344.5, 298]], [[421.5, 307], [417.5, 305], [414.5, 302], [414.5, 302], [411.5, 300], [414.5, 303], [417.5, 305], [412.5, 304], [418.5, 311], [417.5, 320], [419.5, 332], [417.5, 342], [417.5, 349], [422.5, 355], [419.5, 354], [419.5, 354], [419.5, 352], [417.5, 349], [409.5, 339], [408.5, 332], [405.5, 323], [397.5, 313], [394.5, 303], [396.5, 293], [403.5, 282], [414.5, 272], [426.5, 261], [436.5, 252], [447.5, 250], [450.5, 252], [455.5, 253], [453.5, 255], [460.5, 259]], [[581.5, 284], [578.5, 279], [579.5, 279], [577.5, 275], [573.5, 274], [576.5, 276], [566.5, 277], [552.5, 278], [535.5, 281], [521.5, 289], [508.5, 295], [501.5, 298], [500.5, 301], [501.5, 306], [507.5, 311], [523.5, 318], [534.5, 322], [555.5, 325], [572.5, 328], [585.5, 331], [595.5, 337], [602.5, 342], [600.5, 346], [600.5, 351], [596.5, 358], [586.5, 359], [577.5, 366], [564.5, 372], [538.5, 375], [512.5, 378], [484.5, 385], [461.5, 391], [444.5, 395], [439.5, 395], [439.5, 395], [445.5, 395], [461.5, 391]], [[648.5, 296], [648.5, 296], [649.5, 293], [650.5, 293], [646.5, 293], [646.5, 293], [645.5, 293], [647.5, 297], [639.5, 302], [646.5, 315], [647.5, 328], [649.5, 340], [652.5, 351], [653.5, 357], [663.5, 365], [675.5, 368], [684.5, 367], [694.5, 361], [706.5, 355], [709.5, 343], [716.5, 332], [719.5, 318], [729.5, 308], [728.5, 293], [734.5, 285], [730.5, 275], [728.5, 272], [721.5, 267], [713.5, 265], [710.5, 262], [709.5, 263], [712.5, 266], [721.5, 275]], [[799.5, 339], [799.5, 339], [797.5, 335], [803.5, 334], [808.5, 324], [822.5, 316], [832.5, 308], [836.5, 298], [844.5, 293], [847.5, 288], [845.5, 283], [839.5, 279], [826.5, 277], [811.5, 279], [791.5, 282], [769.5, 289], [757.5, 300], [747.5, 310], [737.5, 319], [738.5, 327], [744.5, 339], [755.5, 350], [773.5, 361], [793.5, 366], [810.5, 367], [834.5, 366], [860.5, 361], [883.5, 354], [899.5, 342], [918.5, 335], [926.5, 326], [932.5, 316], [933.5, 308], [936.5, 302], [931.5, 295], [928.5, 290], [923.5, 284], [920.5, 281], [919.5, 282], [916.5, 281], [918.5, 285], [923.5, 291], [927.5, 301], [926.5, 310], [931.5, 320], [939.5, 329], [945.5, 335], [945.5, 335], [948.5, 337], [946.5, 333], [947.5, 330], [946.5, 325], [941.5, 317], [941.5, 310], [935.5, 303], [938.5, 298], [937.5, 293], [941.5, 284], [949.5, 278], [954.5, 270], [961.5, 265], [969.5, 258], [976.5, 253], [987.5, 251], [991.5, 250], [997.5, 248], [1007.5, 248], [1016.5, 248], [1025.5, 248], [1029.5, 247], [1034.5, 248], [1033.5, 249], [1032.5, 250]]],
              [[[121.5, 318], [121.5, 319], [121.5, 319], [121.5, 319], [117.5, 317], [117.5, 317], [116.5, 318], [119.5, 320], [118.5, 322], [118.5, 327], [118.5, 337], [115.5, 350], [118.5, 370], [113.5, 385], [115.5, 408], [118.5, 432], [121.5, 456], [123.5, 480], [128.5, 507], [131.5, 530], [135.5, 553], [138.5, 571], [142.5, 588], [145.5, 602], [144.5, 608], [145.5, 612], [144.5, 612], [147.5, 615], [146.5, 616], [143.5, 613], [142.5, 609], [141.5, 605], [140.5, 600], [137.5, 592], [140.5, 585], [134.5, 574], [135.5, 569], [133.5, 560], [133.5, 555], [134.5, 549], [137.5, 542], [139.5, 530], [151.5, 519], [159.5, 502], [176.5, 492], [188.5, 478], [198.5, 469], [205.5, 463], [207.5, 461], [212.5, 462], [207.5, 461], [205.5, 463], [198.5, 463], [198.5, 469], [188.5, 472], [181.5, 484], [169.5, 499], [159.5, 518], [149.5, 536], [143.5, 547], [145.5, 555], [145.5, 560], [152.5, 565], [161.5, 569], [168.5, 567], [181.5, 567], [195.5, 566], [209.5, 564], [222.5, 564], [231.5, 562], [237.5, 561], [241.5, 563], [241.5, 564]], [[259.5, 490], [260.5, 489], [256.5, 487], [256.5, 487], [256.5, 488], [255.5, 489], [255.5, 489], [257.5, 492], [261.5, 499], [264.5, 508], [268.5, 519], [270.5, 529], [274.5, 540], [279.5, 552], [279.5, 558], [283.5, 565], [283.5, 565], [284.5, 564], [284.5, 564], [277.5, 559], [271.5, 554]], [[256.5, 348], [253.5, 345], [253.5, 344], [251.5, 342], [252.5, 340], [252.5, 340], [248.5, 338], [252.5, 340], [252.5, 340], [252.5, 340], [253.5, 339], [257.5, 342], [256.5, 337]], [[362.5, 489], [359.5, 486], [358.5, 487], [358.5, 487], [355.5, 485], [358.5, 487], [354.5, 486], [353.5, 486], [352.5, 488], [345.5, 489], [331.5, 490], [323.5, 493], [319.5, 496], [316.5, 499], [314.5, 506], [313.5, 517], [310.5, 531], [309.5, 548], [312.5, 566], [318.5, 577], [332.5, 585], [350.5, 586], [374.5, 581], [403.5, 576], [429.5, 569], [445.5, 560], [464.5, 558], [479.5, 556], [488.5, 552]], [[439.5, 373], [436.5, 370], [434.5, 366], [437.5, 369], [436.5, 370], [434.5, 372], [435.5, 376], [437.5, 386], [439.5, 401], [438.5, 419], [442.5, 443], [441.5, 465], [447.5, 493], [447.5, 514], [454.5, 535], [458.5, 549], [460.5, 556], [459.5, 557], [459.5, 557], [460.5, 556], [462.5, 554], [461.5, 546], [463.5, 532], [465.5, 515], [473.5, 501], [479.5, 489], [488.5, 482], [495.5, 475], [498.5, 472], [499.5, 471], [499.5, 471], [497.5, 472], [499.5, 477], [497.5, 479], [494.5, 487], [489.5, 502], [484.5, 518], [486.5, 533], [492.5, 543], [506.5, 553], [515.5, 555], [527.5, 554], [545.5, 554], [563.5, 547], [582.5, 535], [600.5, 523], [617.5, 511], [627.5, 501], [634.5, 494], [639.5, 489], [636.5, 481], [633.5, 472], [629.5, 465], [624.5, 459], [616.5, 455], [606.5, 454], [596.5, 455], [586.5, 458], [578.5, 467], [568.5, 475], [558.5, 485], [557.5, 503], [557.5, 520], [564.5, 536], [572.5, 549], [587.5, 558], [610.5, 564], [632.5, 564], [659.5, 561], [686.5, 556], [708.5, 552], [726.5, 550], [743.5, 549]], [[781.5, 493], [779.5, 489], [777.5, 485], [775.5, 482], [776.5, 475], [773.5, 467], [769.5, 460], [763.5, 454], [752.5, 448], [743.5, 446], [728.5, 444], [717.5, 450], [703.5, 459], [685.5, 466], [673.5, 478], [668.5, 495], [661.5, 508], [663.5, 523], [669.5, 534], [679.5, 541], [688.5, 543], [702.5, 546], [712.5, 542], [728.5, 536], [741.5, 523], [757.5, 513], [768.5, 496], [776.5, 475], [781.5, 458], [777.5, 438], [779.5, 426], [770.5, 405], [767.5, 390], [762.5, 373], [763.5, 359], [760.5, 344], [762.5, 337], [762.5, 336], [762.5, 336], [765.5, 339], [763.5, 341], [763.5, 352], [765.5, 369], [770.5, 393], [773.5, 414], [778.5, 438], [784.5, 462], [789.5, 484], [796.5, 506], [800.5, 519], [807.5, 529], [810.5, 532], [814.5, 533], [811.5, 530], [808.5, 528], [805.5, 525], [797.5, 523]]],
              [[[201.5, 226], [198.5, 225], [199.5, 224], [198.5, 225], [198.5, 225], [198.5, 226], [196.5, 227], [197.5, 232], [203.5, 245], [206.5, 262], [206.5, 279], [214.5, 308], [219.5, 342], [222.5, 377], [225.5, 411], [227.5, 440], [233.5, 465], [235.5, 481], [239.5, 494], [237.5, 498], [237.5, 498], [236.5, 499], [234.5, 495], [236.5, 491], [239.5, 489]], [[166.5, 413], [165.5, 414], [165.5, 414], [165.5, 416], [164.5, 417], [167.5, 419], [164.5, 417], [167.5, 417], [176.5, 420], [186.5, 420], [201.5, 420], [215.5, 417], [236.5, 417], [256.5, 417], [276.5, 418], [295.5, 420], [309.5, 421], [311.5, 418], [317.5, 418], [318.5, 417], [314.5, 408]], [[307.5, 234], [304.5, 231], [307.5, 234], [306.5, 235], [305.5, 236], [303.5, 238], [306.5, 248], [305.5, 263], [307.5, 286], [312.5, 312], [314.5, 342], [315.5, 374], [320.5, 407], [322.5, 436], [331.5, 465], [335.5, 484], [341.5, 502], [348.5, 519], [350.5, 530], [354.5, 537], [353.5, 539], [353.5, 539], [353.5, 538], [355.5, 536], [355.5, 523], [354.5, 505], [356.5, 484], [361.5, 465], [362.5, 445], [365.5, 427], [374.5, 410], [381.5, 393], [390.5, 381], [401.5, 380], [406.5, 380], [416.5, 388], [423.5, 398], [430.5, 415], [435.5, 436], [443.5, 457], [449.5, 476], [456.5, 494], [464.5, 508], [472.5, 518], [485.5, 527], [498.5, 531], [507.5, 531], [520.5, 528], [531.5, 520], [546.5, 508], [558.5, 492], [567.5, 473], [575.5, 457], [580.5, 441], [580.5, 429], [579.5, 417], [574.5, 409], [565.5, 402], [550.5, 395], [539.5, 397], [523.5, 398], [513.5, 405], [506.5, 415], [500.5, 430], [495.5, 448], [495.5, 469], [500.5, 489], [507.5, 506], [517.5, 519], [534.5, 528], [557.5, 532], [587.5, 534], [613.5, 531], [637.5, 526], [661.5, 522], [679.5, 516], [692.5, 513], [698.5, 511], [699.5, 509], [697.5, 506]]],
              [[[72, 391], [72, 390], [70, 388], [70, 388], [73, 388], [70, 388], [72, 391], [70, 392], [72, 403], [74, 415], [76, 433], [76, 448], [76, 462], [74, 470], [79, 479], [77, 475], [76, 476], [77, 473], [72, 467], [69, 458], [68, 445], [65, 429], [62, 412], [67, 397], [66, 385], [69, 374], [70, 365], [74, 359], [75, 351], [85, 342], [101, 333], [122, 324], [143, 320], [160, 315], [172, 319], [180, 322], [188, 332]], [[354, 353], [354, 355], [347, 350], [345, 347], [339, 342], [331, 338], [328, 335], [321, 333], [304, 328], [289, 330], [265, 330], [253, 336], [241, 339], [234, 349], [226, 361], [218, 373], [218, 388], [222, 405], [230, 421], [236, 433], [244, 442], [256, 445], [266, 445], [270, 441], [282, 437], [286, 423], [296, 409], [302, 391], [312, 375], [316, 363], [319, 357], [316, 355], [316, 354], [308, 351], [308, 352], [307, 354], [305, 357], [308, 367], [311, 383], [316, 405], [323, 424], [325, 436], [333, 447], [337, 455], [345, 458], [347, 460], [354, 458], [361, 454], [370, 441]], [[416, 331], [409, 327], [412, 329], [413, 328], [413, 328], [412, 329], [415, 332], [428, 334], [446, 337], [470, 335], [499, 333], [528, 331], [552, 330], [568, 326], [586, 328], [587, 327], [586, 327], [581, 327], [571, 330], [545, 333], [521, 344], [493, 350], [470, 365], [443, 379], [425, 400], [407, 419], [400, 439], [389, 448], [388, 456], [394, 462], [398, 465], [410, 467], [426, 465], [451, 462], [473, 458], [504, 455], [531, 455], [566, 453], [595, 452], [618, 453], [639, 455], [650, 455], [663, 455], [673, 454], [683, 453]], [[799, 390], [801, 389], [801, 382], [796, 372], [793, 361], [791, 349], [783, 340], [772, 334], [762, 329], [753, 326], [740, 325], [730, 328], [714, 332], [692, 337], [675, 351], [657, 364], [646, 383], [633, 397], [631, 417], [635, 433], [642, 444], [665, 453], [687, 456], [714, 457], [740, 452], [767, 447], [792, 434], [810, 420], [828, 405], [842, 390], [843, 372], [838, 356], [827, 342], [810, 332], [796, 325], [777, 318], [755, 315], [737, 314], [719, 315], [705, 323], [696, 330]], [[913, 329], [910, 325], [907, 322], [905, 318], [902, 315], [902, 315], [905, 318], [904, 319], [903, 322], [907, 331], [912, 347], [906, 359], [905, 375], [903, 387], [903, 395], [905, 399], [906, 398], [905, 400], [903, 395], [902, 390], [900, 376], [900, 360], [900, 345], [893, 330], [891, 318], [890, 310], [887, 301], [891, 294], [895, 288], [898, 281], [909, 277], [925, 273], [946, 267], [961, 265], [979, 265], [994, 264], [1007, 265], [1012, 264], [1011, 265], [1012, 264], [1012, 264], [1012, 264], [1008, 262], [1013, 263], [1008, 262]]]
]

def generate(request):
    print("mock")
    return JsonResponse({"success": True, "words": mock_words})

def save(request):
    submit_data = json.loads(request.body)

    design = Design(name=submit_data["name"], elements=submit_data["elements"])
    design.save()

    return JsonResponse({"success": True})


def robodraw(request):
    submit_data = json.loads(request.body)
    queue = cache.get('queue')
    queue.append(submit_data['elements']['elements'])
    cache.set('queue', queue)

    if len(queue) == 1:
        pass
        # instanciate the robot
        #scribus = control.Robot()
        #t = threading.Thread(target=scribus.draw_queue)
        # draw the cmd_list
        #t.start()
    
    return JsonResponse({"success": True})
